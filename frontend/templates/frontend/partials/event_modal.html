<form id="eventForm" method="post">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="eventTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞ *</label>
                <input type="text" class="form-control" id="eventTitle" name="title" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="eventSubject" class="form-label">–ü—Ä–µ–¥–º–µ—Ç *</label>
                <select class="form-select" id="eventSubject" name="subject" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="eventGroup" class="form-label">–ì—Ä—É–ø–ø–∞ *</label>
                <select class="form-select" id="eventGroup" name="group" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="eventTeacher" class="form-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å *</label>
                <select class="form-select" id="eventTeacher" name="teacher" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="eventRoom" class="form-label">–ö–∞–±–∏–Ω–µ—Ç *</label>
                <select class="form-select" id="eventRoom" name="room" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–±–∏–Ω–µ—Ç</option>
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="eventDuration" class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω) *</label>
                <input type="number" class="form-control" id="eventDuration" name="duration" value="45" min="15" max="240" required>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="eventDate" class="form-label">–î–∞—Ç–∞ *</label>
                <input type="date" class="form-control" id="eventDate" name="date" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="eventTime" class="form-label">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ *</label>
                <input type="time" class="form-control" id="eventTime" name="start_time" required>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label for="eventNotes" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
        <textarea class="form-control" id="eventNotes" name="notes" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —É—Ä–æ–∫–µ"></textarea>
    </div>

    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i>
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Ä–æ–∫
        </button>
    </div>
</form>

<script>
// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤ –∫–æ–≥–¥–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üß™ Modal DOM loaded, starting data load...');
    loadEventModalData();
});

async function loadEventModalData() {
    try {
        console.log('üîÑ Loading modal data...');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const responses = await Promise.all([
            fetch('/api/v1/subjects/'),
            fetch('/api/v1/groups/'), 
            fetch('/api/v1/teachers/'),
            fetch('/api/v1/rooms/')
        ]);
        
        console.log('üì° API responses:', responses.map(r => r.status));
        
        const [subjects, groups, teachers, rooms] = await Promise.all([
            responses[0].json(),
            responses[1].json(),
            responses[2].json(),
            responses[3].json()
        ]);

        console.log('üìä Data loaded:', { 
            subjects: subjects.results?.length || subjects.length || 0, 
            groups: groups.results?.length || groups.length || 0,
            teachers: teachers.results?.length || teachers.length || 0,
            rooms: rooms.results?.length || rooms.length || 0
        });

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç—ã (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, —Ç–∞–∫ –∏ –æ–±—ã—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã)
        populateSelect('eventSubject', subjects.results || subjects, 'name');
        populateSelect('eventGroup', groups.results || groups, 'name');
        populateSelect('eventTeacher', teachers.results || teachers, teacher => `${teacher.user?.first_name || ''} ${teacher.user?.last_name || ''}`.trim() || '–ë–µ–∑ –∏–º–µ–Ω–∏');
        populateSelect('eventRoom', rooms.results || rooms, 'name');

        console.log('‚úÖ Modal data loaded successfully');

    } catch (error) {
        console.error('‚ùå Error loading modal data:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã', 'error');
    }
}

function populateSelect(selectId, items, textProperty) {
    const select = document.getElementById(selectId);
    if (!select) return;

    // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π (placeholder)
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–ø—Ü–∏–∏
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        
        if (typeof textProperty === 'function') {
            option.textContent = textProperty(item);
        } else {
            option.textContent = item[textProperty];
        }
        
        select.appendChild(option);
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
document.getElementById('eventForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const formData = new FormData(this);
        const eventData = Object.fromEntries(formData.entries());
        
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç API –≤—ã–∑–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
        console.log('Creating event:', eventData);
        showToast('–£—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
        modal.hide();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        if (window.scheduleCalendar) {
            window.scheduleCalendar.refresh();
        }
        
    } catch (error) {
        console.error('Error creating event:', error);
        showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É—Ä–æ–∫–∞', 'error');
    }
});
</script> 